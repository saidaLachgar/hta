<style>
  td:empty::after{
    content: "—";
    color: #5f6168;
    text-align: center;
  }
</style>
<div class="container-fluid mb-5">

  <!-- statistics -->
  <div class="row">
    <div class="col">
      <div class="card card-body">

        <!-- title -->
        <div class="clearfix">
              <div class="float-end">
                  <div class="input-group input-group-sm">
                      <select class="form-select form-select-sm">
                          <option value="january" selected>Jan</option>
                          <option value="december">Dec</option>
                          <option value="november">Nov</option>
                          <option value="october">Oct</option>
                      </select>
                      <label class="input-group-text">Mois</label>
                  </div>
              </div>
              <h4 class="card-title mb-4">Analyses mensuelles</h4>
        </div>

        <div class="row justify-content-between">
          <div class="col-3">
            <div class="border p-3 rounded-3 mb-2">
              <p class="fw-medium mb-3">Total des interruptions</p>
              <strong class="h2">27</strong>
            </div>
            <div class="border p-3 rounded-3">
              <p class="fw-medium mb-2">Durée moyenne</p>
              <p class="mt-2 mb-2">
                <span class="badge badge-soft-success font-size-11 me-2"> 0.6% 
                <i class="mdi mdi-arrow-up"></i></span><small>De la période précédente</small>
              </p>
              <strong class="h2 mb-0">1h 20min</strong>
            </div>
          </div>
          <div class="col-auto">
            <p class="fw-bold mb-3">Causes des interruptions</p>
              <apx-chart
                [series]="causesChart.series"
                [chart]="causesChart.chart"
                [labels]="causesChart.labels"
                [responsive]="causesChart.responsive"
              ></apx-chart>
          </div>
          <div class="col-3">
            <p class="fw-bold mb-3">Interruptions par type</p>
              <apx-chart
                [series]="typesChart.series"
                [chart]="typesChart.chart"
                [dataLabels]="typesChart.dataLabels"
                [plotOptions]="typesChart.plotOptions"
                [yaxis]="typesChart.yaxis"
                [xaxis]="typesChart.xaxis"
                [legend]="typesChart.legend"
                [colors]="typesChart.colors"
                [grid]="typesChart.grid"
              ></apx-chart>
          </div>
        </div>
        <!-- cards -->
      </div>
    </div>
    <div class="col-4">
      <div class="card card-body">
        <div class="fw-bold mb-4">
          DMS <small class="text-muted font-size-12">(Moyenne des interruptions de l'année en cours)</small>
          <div class="float-end">
            <ul class="nav nav-pills">
              <li class="nav-item">
                <a class="nav-link py-1 px-2" href="javascript: void(0);" (click)="ReportDMS(false)"
                [ngClass]="{'active': !DMSMonthly}">Année</a>
              </li>
              <li class="nav-item">
                  <a class="nav-link font-size-12 py-1 px-2" href="javascript: void(0);" (click)="ReportDMS(true)"
                      [ngClass]="{'active': DMSMonthly}">Mois</a>
              </li>
            </ul>
          </div>
        </div>
        <apx-chart
          [series]="DMSChart.series"
          [chart]="DMSChart.chart"
          [xaxis]="DMSChart.xaxis"
          [stroke]="DMSChart.stroke"
          [tooltip]="DMSChart.tooltip"
          [dataLabels]="DMSChart.dataLabels"
          [colors]="DMSChart.colors"
        ></apx-chart>
      </div>
    </div>
  </div>


  <!-- title -->
  <div class="row align-items-center justify-content-between mb-4">
    <div class="col-auto">
      <app-page-title
        title="Liste des travaux"
        [breadcrumbItems]="breadCrumbItems"
      ></app-page-title>
    </div>
    <div class="col-auto">
    <button class="btn bg-light text-primary ms-2" title="Exporter">
      <i class="fas fa-upload"></i>
    </button>
    <button class="btn bg-light text-primary ms-2" title="Importer">
      <i class="fas fa-download"></i>
    </button>
    <button class="btn btn-primary ms-2" (click)="ShowSearch = !ShowSearch"><i class="fas fa-filter me-1"></i>Filtres</button>
    <a routerLink="/mission/persist" class="btn btn-primary ms-2" *ngIf="authService.isAuthorized('mission_add')"><i class="fas fa-plus-circle"></i> Ajouter</a>
  </div>
  </div>

  <!-- search -->
  <form [class.d-none]="!ShowSearch" [formGroup]="service.missionForm" (ngSubmit)="service.onSearch()" class="row">
    <div class="col-12">
      <div class="card card-body">
        <div class="row g-3">
          <div class="col-12">
            <label class="mt-3 me-3">Type</label>
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="radio"
                formControlName="type"
                id="type-1"
                value="true"
              />
              <label class="form-check-label" for="type-1">
                Incident
              </label>
            </div>
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="radio"
                formControlName="type"
                id="type-2"
                value="false"
              />
              <label class="form-check-label" for="type-2">
                Coupeur / Ouverture
              </label>
            </div>
          </div>
          <div class="col-4">
            <label>Départ</label>
            <ng-select [items]="service.departments$ | async"
                      #searchDepar
                      formControlName="department.id[]"
                      bindLabel="titre"
                      bindValue="id"
                      [multiple]="true"
                      [minTermLength]="2"
                      placeholder="Départ.."
                      [loading]="service.departmentLoading"
                      typeToSearchText="Veuillez saisir 2 caractères ou plus"
                      [typeahead]="service.departmentInput$">
            </ng-select>
          </div>
          <div class="col-4">
            <label>Point coupure</label>
            <ng-select [items]="service.ANode$ | async"
                #searchANode
                formControlName="node_a.id[]"
                bindLabel="titre"
                bindValue="id"
                [multiple]="true"
                [minTermLength]="2"
                placeholder="De.."
                [loading]="service.ANodeLoading"
                typeToSearchText="Veuillez saisir 2 caractères ou plus"
                [typeahead]="service.ANodeInput$">
            </ng-select>
          </div>
          <div class="col-4">
            <label>Ps</label>
            <ng-select [items]="service.BNode$ | async"
                #searchBNode
                formControlName="node_b.id[]"
                bindLabel="titre"
                bindValue="id"
                [multiple]="true"
                [minTermLength]="2"
                placeholder="De.."
                [loading]="service.BNodeLoading"
                typeToSearchText="Veuillez saisir 2 caractères ou plus"
                [typeahead]="service.BNodeInput$">
            </ng-select>
          </div>
          <div class="col-4">
            <label>Date</label>
            <div class="d-flex gap-2">
            <div class="input-group clockpicker">
              <input #searchDateStart ngbDatepicker formControlName="after" class="form-control" (click)="ds.open()" placeholder="De..." #ds="ngbDatepicker">
            </div>
            <div class="input-group clockpicker">
              <input #searchDateEnd ngbDatepicker formControlName="before" class="form-control" (click)="de.open()" placeholder="À..." #de="ngbDatepicker">
            </div>
            </div>
          </div>
          <div class="col-4">
            <label>Causes</label>
            <select class="form-select" #searchCauses formControlName="causes" autocomplete="false">
              <option value="" selected>Causes...</option>
              <option *ngFor="let cause of causesList.slice(causesList.length / 2); index as i" [value]="(i + 1)">{{ cause }}</option>
            </select>
          </div>
          <div class="col-4">
            <label>IFS</label>
            <input type="text" placeholder="IFS..." formControlName="IFS" #searchIFS class="form-control">
          </div>
          <div class="col-4">
            <label>DMS</label>
            <input type="text" placeholder="DMS..." formControlName="DMS" #searchDMS class="form-control">
          </div>
          
          <div class="col d-flex justify-content-end align-items-end">
            <button class="btn btn-primary me-2" type="submit"><i class="fas fa-filter"></i> Filtrer</button>
            <button type="reset" class="btn text-primary" (click)="service.findAll()">
              <i class="bx bx-x me-1"></i>Réinitialiser
            </button>
          </div>

        </div>
      </div>
    </div>
  </form>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <!-- Table -->
          <!-- {{service.groupData(service.mission$ | async).length}} -->
          <div class="table-responsive">
            <table class="table table-bordered border-deem">
              <thead>
                <tr>
                  <th width="20px"></th>
                  <th width="83px">Type</th>
                  <th width="83px">Date</th>
                  <th>Heure</th>
                  <th>Départ</th>
                  <th>Point coupure</th>
                  <th>PS</th>
                  <th>Causes</th>
                  <th class="font-size-12">Nb Clients interrompus</th>
                  <th>IFS</th>
                  <th>DMS</th>
                  <th class="font-size-12">Anomalies</th>
                  <th width="50px"></th>
                </tr>
              </thead>
              <tbody>
                <!-- table loading || no data -->
                <tr>
                  <td
                    class="text-center"
                    colspan="14"
                    *ngIf="!(service.mission$ | async) && service.loading$ | async"
                  >
                    Chargement...
                  </td>
                  <td
                    class="text-center"
                    colspan="14"
                    *ngIf="(service.mission$ | async) && (service.mission$ | async).length === 0 && service.loaded$ | async"
                  >
                  Aucune donnée trouvée !
                  </td>
                </tr>
                    <tr *ngFor="let item of service.mission$ | async; let i = index" valign="middle">

                      
                      <!-- Partielle ou complète -->
                      <td *ngIf="item.rowspan != -1" [attr.rowspan]="item.rowspan">
                        
                        <!-- is Complète -> if has no ps && source contains letter y -->
                        <ng-container *ngIf="item.node_b.length == 0 && item.node_a.titre.toLowerCase().includes('y'); else partielle">
                          <span class="text-danger" ngbTooltip="Complète" placement="top">
                            <!-- <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 26 26"><path fill="currentColor" d="M24.875 0a1 1 0 0 0-.594.281l-1.656 1.656c-2.204-1.59-5.261-1.305-7.313.657c0 .076-.855.91-1.624 1.656l-.97-.969a1 1 0 0 0-.812-.312a1 1 0 0 0-.125.031a1 1 0 0 0-.5 1.719L13.562 7l-3.28 3.281a1.016 1.016 0 1 0 1.437 1.438L15 8.438L17.563 11l-3.282 3.281a1.016 1.016 0 1 0 1.438 1.438L19 12.438l2.281 2.28a1.016 1.016 0 1 0 1.438-1.437l-.969-.969l1.656-1.624c1.96-1.96 2.159-5.008.625-7.282L25.72 1.72A1 1 0 0 0 24.875 0zM3.906 10.969a1 1 0 0 0-.125.031a1 1 0 0 0-.5 1.719l.969.969l-1.656 1.624c-1.96 1.96-2.159 5.008-.625 7.282L.28 24.28a1.016 1.016 0 1 0 1.44 1.44l1.656-1.657c2.204 1.592 5.261 1.306 7.313-.656c0-.076.855-.91 1.624-1.656l.97.969a1.016 1.016 0 1 0 1.437-1.438l-10-10a1 1 0 0 0-.813-.312z"/></svg> -->
                            <!-- <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 32 32"><path fill="currentColor" d="M9.22 9.5a6.219 6.219 0 0 0-5.885 4.218H1.438v4h1.897a6.216 6.216 0 0 0 12.102-2A6.217 6.217 0 0 0 9.218 9.5zm18.465 4.22c-.944-5.173-5.46-9.095-10.903-9.095v4a7.104 7.104 0 0 1 7.094 7.094a7.106 7.106 0 0 1-7.094 7.092v4.002c5.442-.004 9.96-3.926 10.903-9.096h2.065v-4h-2.065z"/></svg> -->
                            <!-- https://icones.js.org/collection/all?s=network -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M14.59 6L12 8.59L9.41 6L8 7.41L10.59 10L8 12.59L9.41 14L12 11.41L14.59 14L16 12.59L13.41 10L16 7.41L14.59 6M17 3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-4v2h1a1 1 0 0 1 1 1h7v2h-7a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1H2v-2h7a1 1 0 0 1 1-1h1v-2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h10Z"/></svg>
                          </span>
                        </ng-container>
                        <ng-template #partielle>
                          <span class="text-warning" ngbTooltip="Partielle" placement="top">
                            <!-- <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 26 26"><path fill="currentColor" d="M24.875 0a1 1 0 0 0-.594.281l-4.656 4.657c-2.204-1.592-5.261-1.306-7.313.656c0 .076-.855.91-1.624 1.656l-.97-.969A1 1 0 0 0 8.782 6a1 1 0 0 0-.5 1.719l10 10a1.016 1.016 0 1 0 1.438-1.438l-.969-.968l1.656-1.626c1.96-1.96 2.159-5.007.625-7.28l4.688-4.688A1 1 0 0 0 24.875 0zM6.906 7.969A1 1 0 0 0 6.781 8a1 1 0 0 0-.5 1.719l.969.969l-1.656 1.624c-1.96 1.96-2.159 5.008-.625 7.282L.28 24.28a1.016 1.016 0 1 0 1.44 1.44l4.656-4.657c2.204 1.592 5.261 1.306 7.313-.656c0-.076.855-.91 1.624-1.656l.97.969a1.016 1.016 0 1 0 1.437-1.438l-10-10a1 1 0 0 0-.813-.312z"/></svg> -->
                            <!-- <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 32 32"><path fill="currentColor" d="M25.06 13.72c-.944-5.173-5.46-9.095-10.903-9.095v4a7.104 7.104 0 0 1 7.094 7.094a7.104 7.104 0 0 1-7.093 7.092v4.002c5.442-.004 9.96-3.926 10.903-9.096h4.69v-4h-4.69zm-4.685 2a6.216 6.216 0 0 0-12.103-2.002H1.438v4h6.834a6.216 6.216 0 0 0 12.104-2z"/></svg> -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M16 11V9H8v2h8m1-8a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-4v2h1a1 1 0 0 1 1 1h7v2h-7a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1H2v-2h7a1 1 0 0 1 1-1h1v-2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h10Z"/></svg>
                          </span>
                        </ng-template>

                      </td>
                      

                      <!-- type -->
                      <td *ngIf="item.rowspan != -1" [attr.rowspan]="item.rowspan">
                        <div 
                          *ngIf="item.type != null"
                          [ngClass]="item.type ? 'badge-soft-danger' : 'badge-soft-info'"
                          class="badge rounded-pill">
                          {{item.type ? "Incident" : "Coupeur" }}
                        </div>
                      </td>

                      <!-- date -->
                      <td *ngIf="item.rowspan != -1" [attr.rowspan]="item.rowspan">
                        <ngb-highlight
                          [result]="item.dateStart  | date:'dd/MM/yy':'Africa/Casablanca'"
                          [term]="searchDateStart.value+searchDateEnd.value"
                        ></ngb-highlight>
                      </td>
                      <td>
                        {{item.dateStart | date:'HH:mm:ss':'Africa/Casablanca'}} → {{item.dateEnd ? (item.dateEnd  | date:'HH:mm:ss':'Africa/Casablanca') : "— : —"}}<br>
                        <small class="text-muted" *ngIf="item.dateStart && item.dateEnd">Durée : {{getDiff(item.dateStart, item.dateEnd)}}</small>
                      </td>
    
                      <!-- department -->
                      <td *ngIf="item.rowspan != -1" [attr.rowspan]="item.rowspan">
                        <a 
                          *ngIf="item.node_a.department"
                          [routerLink]="authService.isAuthorized('departments_details') ? ['/departments/details', item.node_a.department.id] : null"
                          target="_blank">{{item.node_a.department.titre}}</a>
                      </td>
                      <!-- nodeA -->
                      <td>
                        <a 
                          *ngIf="item.node_a"
                          [routerLink]="authService.isAuthorized('nodes_details') ? ['/nodes/details', item.node_a.id] : null"
                          target="_blank">{{item.node_a.titre}}</a>
                      </td>
                      
                      <!-- nodeB -->
                      <td>
                        <div *ngFor="let node_b of item.node_b">
                          <a 
                            [routerLink]="authService.isAuthorized('nodes_details') ? ['/nodes/details', node_b.id] : null"
                            target="_blank">- {{node_b.titre}}</a>
                        </div>
                      </td>
                      <!-- causes -->
                      <td *ngIf="item.rowspan != -1" [attr.rowspan]="item.rowspan">
                        <ng-container *ngIf="item.type != null && item.type && item.causes;">
                          <ngb-highlight
                            [result]="causesList[item.causes + 3]"
                            [term]="searchCauses.options[searchCauses.options.selectedIndex].text"
                          ></ngb-highlight>
                        </ng-container>
                        <!-- <ng-template #NoCauses>-</ng-template> -->
                      </td>
                      <!-- NB Clients -->
                      <td>{{item.nbClients}}</td>
                      <!-- IFS -->
                      <td><ngb-highlight [result]="item.IFS" [term]="searchIFS.value"></ngb-highlight></td>
                      <!-- DMS -->
                      <td><ngb-highlight [result]="item.DMS" [term]="searchDMS.value"></ngb-highlight></td>
                      <!-- Anomalies -->
                      <td *ngIf="item.rowspan != -1" [attr.rowspan]="item.rowspan">
                        <ng-container *ngIf="item.NbAnomalies != null && item.NbAnomalies > 0; else NoAnomalies">
                          <div  class="badge badge-soft-warning c-pointer rounded-pill border-warning border px-3 py-2 font-size-13 w-100">
                            <i class="fas fa-exclamation-triangle me-2"></i> <span class="text-body">{{item.NbAnomalies}} Anomalies</span>
                          </div>
                        </ng-container>
                        <ng-template #NoAnomalies>
                          <div class="badge badge-soft-success c-pointer rounded-pill border-success border px-3 py-2 font-size-13 w-100">
                            <i class="fas fa-check-circle me-2"></i> <span class="text-body">Pas d'anomalie</span>
                          </div>
                        </ng-template>
                      </td>
                      
                      <!-- actions -->
                      <td align="center">
                        <!-- {{item.id}} -->
                        <div ngbDropdown 
                          placement="bottom-left"
                          *ngIf="authService.isAuthorized('mission_details') || authService.isAuthorized('mission_update') || authService.isAuthorized('mission_delete')"
                          >
                          <i
                            class="fas fa-ellipsis-h dropdown-toggle c-pointer"
                            ngbDropdownToggle
                            data-toggle="dropdown"
                            aria-expanded="true"
                          ></i>
                          <div
                            class="dropdown-menu dropdown-menu-end"
                            ngbDropdownMenu
                          >
                            <a
                              class="dropdown-item bg-success bg-soft"
                              href="javascript: void(0);"
                              *ngIf="item.type && isToday(item.dateStart) && authService.isAuthorized('mission_update')"
                              [routerLink]="['persist', item.id, true]"
                              >
                              <i class="fas fa-play me-2 text-success"></i> Continuer
                            </a>
                            <a class="dropdown-item"
                              [routerLink]="['details', item.id]"
                              href="javascript: void(0);"
                              *ngIf="authService.isAuthorized('mission_details')"
                              >
                              <i class="fas fa-eye me-2"></i> Voir
                            </a>
                            <a
                              class="dropdown-item"
                              href="javascript: void(0);"
                              *ngIf="authService.isAuthorized('mission_update')"
                              [routerLink]="['persist', item.id]"
                              >
                              <!-- skipLocationChange -->
                              <i class="fas fa-edit me-2"></i> Modifier
                            </a>
                           
                            <a
                              class="dropdown-item text-danger"
                              href="javascript: void(0);"
                              *ngIf="authService.isAuthorized('mission_delete')"
                              (click)="service.deleteItem(item.id, $event.target)"
                            >
                              <i class="fas fa-trash me-2"></i> Supprimer
                            </a>
                          </div>
                        </div>
                      </td>
    
                    </tr>
                  <!-- </ng-container> -->
              </tbody>
            </table>
          </div>
          <!-- End table -->
          <!-- Pagination -->
          <ng-container *ngIf="(service.pagination$ | async) as pagination">
            <div
              *ngIf="pagination.totalRecords > service.pageSize"
              class="row justify-content-md-between align-items-md-center mt-2"
            >
              <div class="col-sm-12 col-md-5">
                <div
                  class="dataTables_info mb-2"
                  id="tickets-table_info"
                  role="status"
                  aria-live="polite"
                >
                Affichage de {{pagination.startIndex}} 
                à {{pagination.endIndex}} 
                de {{pagination.totalRecords}} entrées
                </div>
              </div>
              <div class="col-sm-12 col-md-5">
                <div class="text-md-right float-md-end pagination-rounded">
                  <ngb-pagination
                    [collectionSize]="pagination.totalRecords"
                    [(page)]="service.page"
                    [pageSize]="service.pageSize"
                    (pageChange)="service.onPaginate($event)"
                  >
                  </ngb-pagination>
                </div>
              </div>
            </div>
          </ng-container>
          <!-- End Pagination -->
        </div>
      </div>
    </div>
  </div>
</div>