<!-- <style>
  td:empty::after{
    content: "＿";
    color: #74788d;
  }
</style> -->
<div class="container-fluid mb-5">

  <!-- statistics -->
  <div class="row">
    <div class="col">
      <div class="card card-body">

        <!-- title -->
        <div class="clearfix">
              <div class="float-end">
                  <div class="input-group input-group-sm">
                      <select class="form-select form-select-sm">
                          <option value="january" selected>Jan</option>
                          <option value="december">Dec</option>
                          <option value="november">Nov</option>
                          <option value="october">Oct</option>
                      </select>
                      <label class="input-group-text">Mois</label>
                  </div>
              </div>
              <h4 class="card-title mb-4">Analyses mensuelles</h4>
        </div>

        <div class="row justify-content-between">
          <div class="col-3">
            <div class="border p-3 rounded-3 mb-2">
              <p class="fw-medium mb-3">Total des interruptions</p>
              <strong class="h2">27</strong>
            </div>
            <div class="border p-3 rounded-3">
              <p class="fw-medium mb-2">Durée moyenne</p>
              <p class="mt-2 mb-2">
                <span class="badge badge-soft-success font-size-11 me-2"> 0.6% 
                <i class="mdi mdi-arrow-up"></i></span><small>De la période précédente</small>
              </p>
              <strong class="h2 mb-0">1h 20min</strong>
            </div>
          </div>
          <div class="col-auto">
            <p class="fw-bold mb-3">Causes des interruptions</p>
              <apx-chart
                [series]="causesChart.series"
                [chart]="causesChart.chart"
                [labels]="causesChart.labels"
                [responsive]="causesChart.responsive"
              ></apx-chart>
          </div>
          <div class="col-3">
            <p class="fw-bold mb-3">Interruptions par type</p>
              <apx-chart
                [series]="typesChart.series"
                [chart]="typesChart.chart"
                [dataLabels]="typesChart.dataLabels"
                [plotOptions]="typesChart.plotOptions"
                [yaxis]="typesChart.yaxis"
                [xaxis]="typesChart.xaxis"
                [legend]="typesChart.legend"
                [colors]="typesChart.colors"
                [grid]="typesChart.grid"
              ></apx-chart>
          </div>
        </div>
        <!-- cards -->
      </div>
    </div>
    <div class="col-4">
      <div class="card card-body">
        <p class="fw-bold mb-3">DMS / Mois <br><small class="text-muted">(Moyenne des interruptions de l'année en cours)</small></p>
        <apx-chart
          [series]="DMSChart.series"
          [chart]="DMSChart.chart"
          [xaxis]="DMSChart.xaxis"
          [stroke]="DMSChart.stroke"
          [tooltip]="DMSChart.tooltip"
          [dataLabels]="DMSChart.dataLabels"
          [colors]="DMSChart.colors"
        ></apx-chart>
      </div>
    </div>
  </div>

  <div class="row align-items-center justify-content-between mb-4">
    <div class="col-auto">
      <app-page-title
        title="Liste des travaux"
        [breadcrumbItems]="breadCrumbItems"
      ></app-page-title>
    </div>
    <div class="col-auto">
    <button class="btn bg-light text-primary ms-2" title="Exporter">
      <i class="fas fa-upload"></i>
    </button>
    <button class="btn bg-light text-primary ms-2" title="Importer">
      <i class="fas fa-download"></i>
    </button>
    <button class="btn btn-primary ms-2" (click)="ShowSearch = !ShowSearch"><i class="fas fa-filter me-1"></i>Filtres</button>
    <a routerLink="/travaux/persist" class="btn btn-primary ms-2" *ngIf="authService.isAuthorized('travaux_add')"><i class="fas fa-plus-circle"></i> Ajouter</a>
  </div>
  </div>

  <!-- search -->
  <form [class.d-none]="!ShowSearch" [formGroup]="service.travauxForm" (ngSubmit)="service.onSearch()" class="row">
    <div class="col-12">
      <div class="card card-body">
        <div class="row g-3">
          <div class="col-12">
            <label class="mt-3 me-3">Type</label>
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="radio"
                formControlName="type"
                id="type-1"
                value="true"
              />
              <label class="form-check-label" for="type-1">
                Déclenchement
              </label>
            </div>
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="radio"
                formControlName="type"
                id="type-2"
                value="false"
              />
              <label class="form-check-label" for="type-2">
                Coupeur / Ouverture
              </label>
            </div>
          </div>
          <div class="col-4">
            <label>Départements</label>
            <ng-select [items]="service.departements$ | async"
                      #searchDepar
                      formControlName="departements.id[]"
                      bindLabel="titre"
                      bindValue="id"
                      [multiple]="true"
                      [minTermLength]="2"
                      placeholder="Départements.."
                      [loading]="service.departementLoading"
                      typeToSearchText="Veuillez saisir 2 caractères ou plus"
                      [typeahead]="service.departementInput$">
            </ng-select>
          </div>
          <div class="col-4">
            <label>Point coupure</label>
            <ng-select [items]="service.appareils$ | async"
                #searchAppareils
                formControlName="appareil.id[]"
                bindLabel="titre"
                bindValue="id"
                [multiple]="true"
                [minTermLength]="2"
                placeholder="Point coupure.."
                [loading]="service.appareilLoading"
                typeToSearchText="Veuillez saisir 2 caractères ou plus"
                [typeahead]="service.appareilInput$">
            </ng-select>
          </div>
          <div class="col-4">
            <label>Ps</label>
            <ng-select [items]="service.ps$ | async"
                #searchps
                formControlName="ps.id[]"
                bindLabel="titre"
                bindValue="id"
                [multiple]="true"
                [minTermLength]="2"
                placeholder="Ps.."
                [loading]="service.psLoading"
                typeToSearchText="Veuillez saisir 2 caractères ou plus"
                [typeahead]="service.psInput$">
            </ng-select>
          </div>
          <div class="col-4">
            <label>Date</label>
            <div class="d-flex gap-2">
            <div class="input-group clockpicker">
              <input #searchDateStart ngbDatepicker formControlName="after" class="form-control" (click)="ds.open()" placeholder="De..." #ds="ngbDatepicker">
            </div>
            <div class="input-group clockpicker">
              <input #searchDateEnd ngbDatepicker formControlName="before" class="form-control" (click)="de.open()" placeholder="À..." #de="ngbDatepicker">
            </div>
            </div>
          </div>
          <div class="col-4">
            <label>Causes</label>
            <select class="form-select" #searchCauses formControlName="causes" autocomplete="false">
              <option value="" selected>Causes...</option>
              <option *ngFor="let cause of causesList.slice(causesList.length / 2); index as i" [value]="(i + 1)">{{ cause }}</option>
            </select>
          </div>
          <div class="col-4">
            <label>DMS</label>
            <input type="text" placeholder="DMS..." formControlName="DMS" #searchDMS class="form-control">
          </div>
          
          <div class="col d-flex justify-content-end align-items-end">
            <button class="btn btn-primary ms-2" type="submit"><i class="fas fa-filter"></i> Filtrer</button>
            <button type="reset" class="btn text-primary" (click)="service.findAll()">
              <i class="bx bx-x me-1"></i>Réinitialiser
            </button>
          </div>

        </div>
      </div>
    </div>
  </form>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <!-- Table -->
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Durée</th>
                  <th>Départ</th>
                  <th>Point coupure</th>
                  <th>PS</th>
                  <th>Causes</th>
                  <th class="font-size-12">Nb Clients interrompus</th>
                  <th>DMS</th>
                  <th class="font-size-12">Anomalies</th>
                  <th>Date</th>
                  <th width="123px"></th>
                </tr>
              </thead>
              <tbody>
                <!-- table loading || no data -->
                <tr>
                  <td
                    class="text-center"
                    colspan="13"
                    *ngIf="!(service.travaux$ | async) && service.loading$ | async"
                  >
                    Chargement...
                  </td>
                  <td
                    class="text-center"
                    colspan="13"
                    *ngIf="(service.travaux$ | async) && (service.travaux$ | async).length === 0 && service.loaded$ | async"
                  >
                  Aucune donnée trouvée !
                  </td>
                </tr>
                <tr *ngFor="let item of (service.travaux$ | async); let i = index">
                  
                  <!-- type -->
                  <td>
                    <div 
                      *ngIf="item.type != null"
                      [ngClass]="item.type ? 'badge-soft-danger' : 'badge-soft-info'"
                      class="badge rounded-pill">
                      {{item.type ? "Déclenchement" : "Coupeur" }}
                    </div>
                  </td>
                  <td>{{getDiff(item.dateStart, item.dateEnd)}}</td>
                  <!-- departement -->
                  <td>
                    <a 
                      *ngIf="item.departement"
                      [routerLink]="authService.isAuthorized('departements_details') ? ['/departements/details', item.departement.id] : null"
                      target="_blank" rel="noopener noreferrer">{{item.departement.titre}}</a>
                  </td>
                  <!-- appareil source -->
                  <td>
                    <a 
                      *ngIf="item.appareil"
                      [routerLink]="authService.isAuthorized('appareils_details') ? ['/appareils/details', item.appareil.id] : null"
                      target="_blank" rel="noopener noreferrer">{{item.appareil.titre}}</a>
                  </td>
                  <!-- appareil ps -->
                  <td>
                    <a 
                      *ngIf="item.ps"
                      [routerLink]="authService.isAuthorized('appareils_details') ? ['/appareils/details', item.ps.id] : null"
                      target="_blank" rel="noopener noreferrer">{{item.ps.titre}}</a>
                  </td>
                  <!-- causes -->
                  <td>
                    <ng-container *ngIf="item.type != null && item.type; else NoCauses">
                      <ngb-highlight
                        [result]="causesList[item.causes + 3]"
                        [term]="searchCauses.options[searchCauses.options.selectedIndex].text"
                      ></ngb-highlight>
                    </ng-container>
                    <ng-template #NoCauses>-</ng-template>
                  </td>
                  <!-- NB Clients -->
                  <td>{{item.nbClients}}</td>
                  <!-- DMS -->
                  <td><ngb-highlight [result]="item.DMS" [term]="searchDMS.value"></ngb-highlight></td>
                  <!-- Anomalies -->
                  <td>
                    <ng-container *ngIf="item.NbAnomalies != null && item.NbAnomalies > 0; else NoAnomalies">
                      <div  class="badge badge-soft-warning c-pointer rounded-pill border-warning border px-3 py-2 font-size-13 w-100">
                        <i class="fas fa-exclamation-triangle me-2"></i> <span class="text-body">{{item.NbAnomalies}} Anomalies</span>
                      </div>
                    </ng-container>
                    <ng-template #NoAnomalies>
                      <div class="badge badge-soft-success c-pointer rounded-pill border-success border px-3 py-2 font-size-13 w-100">
                        <i class="fas fa-check-circle me-2"></i> <span class="text-body">Pas d'anomalie</span>
                      </div>
                    </ng-template>
                  </td>
                  
                  <!-- date -->
                  <td>
                    <ngb-highlight
                      [result]="item.dateStart  | date:'long'"
                      [term]="searchDateStart.value+searchDateEnd.value"
                    ></ngb-highlight>
                  </td>
                  <!-- actions -->
                  <td align="center">
                    <div ngbDropdown 
                      placement="bottom-left"
                      *ngIf="authService.isAuthorized('travaux_details') || authService.isAuthorized('travaux_update') || authService.isAuthorized('travaux_delete')"
                      >
                      <i
                        class="fas fa-ellipsis-h dropdown-toggle c-pointer"
                        ngbDropdownToggle
                        data-toggle="dropdown"
                        aria-expanded="true"
                      ></i>
                      <div
                        class="dropdown-menu dropdown-menu-end"
                        ngbDropdownMenu
                      >
                        <a class="dropdown-item"
                          [routerLink]="['details', item.id]"
                          href="javascript: void(0);"
                          *ngIf="authService.isAuthorized('travaux_details')"
                          >
                          <i class="fas fa-eye me-2"></i> Voir
                        </a>
                        <a
                          class="dropdown-item"
                          href="javascript: void(0);"
                          *ngIf="authService.isAuthorized('travaux_update')"
                          [routerLink]="['persist', item.id]"
                          >
                          <!-- skipLocationChange -->
                          <i class="fas fa-edit me-2"></i> Modifier
                        </a>
                        <a
                          class="dropdown-item text-danger"
                          href="javascript: void(0);"
                          *ngIf="authService.isAuthorized('travaux_delete')"
                          (click)="service.deleteItem(item.id, $event.target)"
                        >
                          <i class="fas fa-trash me-2"></i> Supprimer
                        </a>
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <!-- End table -->
          <!-- Pagination -->
          <ng-container *ngIf="(service.pagination$ | async) as pagination">
            <div
              *ngIf="pagination.totalRecords > service.pageSize"
              class="row justify-content-md-between align-items-md-center mt-2"
            >
              <div class="col-sm-12 col-md-5">
                <div
                  class="dataTables_info mb-2"
                  id="tickets-table_info"
                  role="status"
                  aria-live="polite"
                >
                Affichage de {{pagination.startIndex}} 
                à {{pagination.endIndex}} 
                de {{pagination.totalRecords}} entrées
                </div>
              </div>
              <div class="col-sm-12 col-md-5">
                <div class="text-md-right float-md-end pagination-rounded">
                  <ngb-pagination
                    [collectionSize]="pagination.totalRecords"
                    [(page)]="service.page"
                    [pageSize]="service.pageSize"
                    (pageChange)="service.onPaginate($event)"
                  >
                  </ngb-pagination>
                </div>
              </div>
            </div>
          </ng-container>
          <!-- End Pagination -->
        </div>
      </div>
    </div>
  </div>
</div>